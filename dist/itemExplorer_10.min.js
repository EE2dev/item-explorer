var itemExplorerChart=function(t){"use strict";function e(e){e.each(function(r){le&&N(),console.log(r),console.log("_myData "+t),"undefined"!=typeof r?a(e,r):"undefined"!=typeof t?n(t,e):n("<pre>",e)})}function n(t,e){"<pre>"!==t?d3.csv(t,r,function(t,n){a(e,n)}):(R=d3.csv.parse(d3.select("pre#data").text()),R.forEach(function(t){r(t)}),console.log("hier"),console.log(R),a(e,R))}function r(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(t[e]=+t[e]);return t}function a(t,e){t.each(function(){R=e,o(R),Y=d3.scale.linear().range([he,0]),","===ie?W=d3.svg.axis().scale(Y).orient("left").ticks(10,X):(X=X?X:",.0f",W=d3.svg.axis().scale(Y).orient("left").tickFormat(ce.numberFormat(X)));var t=d3.select(this);G=t.append("svg").call(i);var n,r=0;d3.select("g.padding").append("g").attr("class","allTooltips"),U.forEach(function(t,e){n=d3.select("g.padding").datum(e).insert("g","g.allTooltips").attr("class","groupBlock group"+t),n.append("g").attr("class","x axis").attr("transform","translate(0,"+he+")"),d3.select(e.selector+">.x.axis").call(e.axis),0===r?p(!0,t):p(!1,t),r++})})}function i(t){t.attr("width",de).attr("height",fe).attr("class","IEChart").append("g").attr("class","margin").attr("transform","translate("+se.left+","+se.top+")").append("g").attr("class","padding").attr("transform","translate("+ue.left+","+ue.top+")")}function o(t){var e,n,r=d3.keys(t[0]).filter(function(t){return"_"===t.substring(0,1)?(z=t,!1):!0});return H=r.map(function(t,r){return n={item:t,itemShort:t,itemLong:t,color:"rgb(70, 130, 180)",frequency:0,index:r,group:""},e=t.split(":"),l(n,e),n}),d(),r=r.map(function(t){var e=t.split(":");return e[0]})}function l(t,e){t.itemLong=e[0],t.itemShort=e[0],e.forEach(function(e){switch(e.substring(0,3)){case"CO=":t.color=e.slice(3),"rgb"===t.color.substr(0,3)&&(t.color=t.color.replace(/ /g,","));break;case"LN=":t.itemLong=e.slice(3);break;case"DI=":t.group=e.slice(3).replace(/\s+/g,"_")}}),u(t.itemShort,t.group)}function c(t){return t.split(":")[0]}function s(t){var e=t.split(":"),n=e[0];return e.forEach(function(t){"LN="===t.substring(0,3)&&(n=t.slice(3))}),n}function u(t,e){var n;U.has(e)?(n=U.get(e),n.items.push(t)):n={items:[t],data:[],selector:"g.group"+e,width:-1,xScale:null,axis:null,firstTime:!0},U.set(e,n)}function d(){U.forEach(function(t,e){var n=e;n.width=e.items.length*ae,n.xScale=d3.scale.ordinal().domain(n.items).rangeRoundBands([0,n.width],.1),n.axis=d3.svg.axis().scale(n.xScale).orient("bottom"),U.set(t,n)})}function f(t){Y.domain([0,_]);var e=d3.select(t.selector);e.insert("g","g.x.axis").attr("class","y axis").append("text").attr("x",-5).attr("y",-14).attr("dy",".71em").style("text-anchor","end").text(z.slice(1,z.length));var n=e.selectAll(".x>.tick").data(t.data),r=e.select(".x.axis").selectAll("g.tick").append("g").attr("class","indicator");e.selectAll(".x.axis g.tick>text").attr("class","unselect"),r.append("rect").attr("class","colorIndicator").attr("x",t.xScale.rangeBand()/2*-1).attr("y",0).attr("width",t.xScale.rangeBand()).attr("height",25).style("stroke","black").style("stroke-width",2).style("opacity",0),r.append("g").attr("class","altIndicator").style("stroke","black").style("stroke-width",2).style("opacity",.5),e.select("g.x.axis").append("text").attr("x",function(t){return t.width}).attr("y",28).attr("dy",".71em").style("text-anchor","end").text(t.selector.split("g.group")[1].replace("_"," ")),n.append("rect").attr("class","bar drawn").attr("x",-t.xScale.rangeBand()/2).attr("width",t.xScale.rangeBand()).attr("y",0).attr("height",0).style("fill",function(t){return t.color});var a=t.selector.split("g.")[1],i=d3.select("g.allTooltips").append("g").attr("class","toolTipTrans "+a).datum(t).selectAll("g.gtooltip").data(t.data,function(t){return t.itemShort}).enter().append("g").attr("class","gtooltip");i.attr("transform",function(t){var e=d3.selectAll(".x>.tick").filter(function(e){return e===t}).attr("transform");return e=e===e.split(",")[0]?e.substr(0,e.length-1)+", "+he+")":e.split(",")[0]+", "+he+")"}),i.append("rect").attr("class","selection bar unselect").attr("x",-t.xScale.rangeBand()/2).attr("width",t.xScale.rangeBand()).attr("y",function(){return-(he-Y(_))}).attr("height",he+20-Y(_)).on("mouseover",function(t){h(t)}).on("mouseout",function(){d3.selectAll(".tooltip").remove()}).on("click",function(t){d3.selectAll(".tooltip").remove(),d3.event.altKey?x(t.item):v(t.item,!0)}),e.select(".y.axis").call(W),F()}function p(t,e){var n;n="undefined"==typeof e?{items:[],data:H,selector:"g.group"}:U.get(e),t&&(J=0,B(),R.forEach(function(t){Q&&(V+=t[z]),y(t)&&(J+=t[z],T(t),H.forEach(function(e){1===t[e.item]&&(e.frequency+=t[z])}))})),n.data=H.filter(function(t){return-1!==n.items.indexOf(t.itemShort)});var r=d3.select("svg").transition().duration(750);if(Q){_=d3.max(H,function(t){return t.frequency}),f(n),n.firstTime=!1,U.set(e,n);var a=!1;if(U.forEach(function(t,e){a=a||e.firstTime}),Q=a,Q===!1){var i=0,o=0,l=15;r.selectAll(".groupBlock").attr("transform",function(t,e){var n=i;o=d3.select(this).select("g.x.axis").node().getBBox().width+d3.select(this).select("g.y.axis").node().getBBox().width,i+=o+l,0===e&&d3.select(this).select("g.y.axis").node().getBBox().width>ue.left&&(ue.left=d3.select(this).select("g.y.axis").node().getBBox().width,d3.select("svg.IEChart g.padding").attr("transform","translate("+ue.left+", "+ue.top+")"));var r="translate("+n+", 0)";return d3.selectAll("g.toolTipTrans").filter(function(e){return e===t}).attr("transform",r),r});var c=d3.select("svg.IEChart"),s=i+ue.left;if(500>s){s=500;var u=se.left+s/2-(i+ue.left)/2;d3.select("svg.IEChart>g").attr("transform","translate("+u+", 0)")}c.attr("width",s),K=c.node().getBoundingClientRect().left,P=c.node().getBoundingClientRect().right,c.attr("height",he+se.top+ue.top+ue.bottom+se.bottom)}}if(!Q){j=document.getElementById("update_axis").checked?d3.max(H,function(t){return t.frequency}):_,Y.domain([0,j]),k(),q(),r.selectAll(".y.axis").call(W);var d=r.selectAll(".bar.drawn").attr("y",function(t){return-(he-Y(t.frequency))}).attr("height",function(t){return he-Y(t.frequency)});t&&document.getElementById("sort").checked&&d.call(m,function(){O()}),oe&&d3.selectAll(".y.axis").each(function(t){var e=t.width;d3.select(this).selectAll("g.tick").filter(function(t){return 0!==t}).append("path").attr("class","horizontalGrid").attr("d","M 0 0 L "+e+" 0")})}}function h(t){var e,n=41,r=-(he-Y(t.frequency))-n-10,a=r+n+10,i=d3.selectAll("g.gtooltip").filter(function(e){return e===t}),o=i.insert("g",".selection.bar").attr("class","tooltip textBoxGroup"),l=o.append("g").attr("class","tooltip textgroup");l.append("text").attr("class","tooltip firstLine").attr("x",0).attr("y",r+5).attr("dy",".71em").attr("fill","black").attr("text-anchor","middle").text(t.itemLong),l.append("text").attr("class","tooltip secondLine").attr("x",0).attr("y",r+4+18).attr("dy",".71em").attr("fill","black").attr("text-anchor","middle").text(z.slice(1,z.length)+": "+L(t.frequency)),e=d3.select(".tooltip.textgroup")[0][0].getBBox().width+6;var c=d3.selectAll(".bar.drawn").filter(function(e){return e===t}).style("fill");o.insert("rect",".tooltip.textgroup").attr("class","tooltip box").attr("x",-e/2).attr("y",r).attr("width",e).attr("height",n).style("fill",D(c)).style("stroke",c),g(o),i.insert("path",".selection.bar").attr("class","tooltip triangle").attr("d"," M 0 "+a+"l -10 -10 l 20 0 l -10 10").style("fill",c).style("stroke",c)}function g(t){var e=t.node().getBoundingClientRect().left,n=t.node().getBoundingClientRect().right;K+2>e?(e=K+2-e,t.attr("transform","translate ("+e+" ,0)")):n+2>P&&(n=P-(n+2),t.attr("transform","translate ("+n+" ,0)"))}function m(t,e){var n;t.empty()?e():(n=t.size(),t.each("end",function(){n--,0===n&&e()}))}function y(t){if(Z.empty())return!0;var e=!0;if(Z.forEach(function(n,r){0===r.alternativeId&&(e=t[n]===r.condition?!0&&e:!1)}),!$.empty()){var n;$.forEach(function(r,a){n=!1,a.forEach(function(e,r){n=t[e]===r?!0:!1||n}),e=e&&n})}return e}function v(t,e){if(console.log("update : "+t),null===te||!te.has(t)&&!Z.has(t)){if(Z.has(t)){var n=Z.get(t).alternativeId;if(0!==n){var r=$.get(n);r.size()<=2?($.remove(n),d3.selectAll(".altIndicator").selectAll("path.line.altId"+n).remove()):r.remove(t)}Z.remove(t);var a=Z.entries().filter(function(t){return t.value.alternativeId===n});1===a.length&&Z.set(a[0].key,{condition:Z.get(a[0].key).condition,alternativeId:0})}else if(d3.event.shiftKey)if(null!==te){if(!b(t))return;ee++,te.set(t,0),te.forEach(function(t,e){Z.set(t,{condition:e,alternativeId:ee})}),$.set(ee,te)}else Z.set(t,{condition:0,alternativeId:0});else if(null!==te){if(!b(t))return;ee++,te.set(t,1),te.forEach(function(t,e){Z.set(t,{condition:e,alternativeId:ee})}),$.set(ee,te)}else Z.set(t,{condition:1,alternativeId:0});te=null,e&&(H.forEach(function(t){t.frequency=0}),p(!0))}}function x(t){Z.has(t)||(null===te&&(te=d3.map()),b(t)&&(d3.event.shiftKey?te.has(t)?(te.remove(t),d3.selectAll(".indicator").filter(function(e){return e.item===t}).style("fill","none").style("opacity",0)):te.set(t,0):te.has(t)?(te.remove(t),d3.selectAll(".indicator").filter(function(e){return e.item===t}).style("fill","none").style("opacity",0)):te.set(t,1),ne=S(te.keys(),U.get(te.group).xScale),I(!1,ee+1),d3.selectAll(".indicator").each(function(t){te.has(t.item)&&d3.select(this).select(".colorIndicator").style("fill",function(t){return 1===te.get(t.item)?"green":"red"}).style("opacity",.5)}),te.empty()&&(te=null)))}function b(t){if(te.empty())return H.forEach(function(e){e.item===t&&(te.group=e.group)}),!0;var e,n=te.keys()[0];return H.forEach("undefined"==typeof te.group?function(r){r.item===n&&(te.group=r.group),r.item===t&&(e=r.group)}:function(n){n.item===t&&(e=n.group)}),e===te.group}function k(){var t=d3.round(J/V*100,1)+"%",e=[J,t];d3.selectAll("div.info").data(e).text(function(t){return L(t)}),d3.selectAll(".colorIndicator").each(function(t){Z.has(t.item)?d3.select(this).style("fill",function(t){return 1===Z.get(t.item).condition?"green":"red"}).style("opacity",.5):d3.select(this).style("fill","none").style("opacity",0)}),$.forEach(function(t,e){ne=S(e.keys(),U.get(e.group).xScale),I(!0,t)}),w()}function w(){var t="";Z.forEach(function(e,n){0===n.alternativeId&&(t+=1===n.condition?"+"+s(e)+"\n":"-"+s(e)+"\n")}),$.forEach(function(e,n){t+="(",n.forEach(function(e,n){t+=1===n?"+"+s(e)+" || ":"-"+s(e)+" || "}),t=t.substring(0,t.length-4),t+=")\n"});var e=t.split("\n");d3.selectAll("#selectionTable tr.content").remove();var n;if(e.length>1)for(var r=0;r<e.length-1;r++)n=d3.select("#selectionTable tbody").append("tr").attr("class","content"),n.append("td").text(e[r]);else if(1===e.length)for(var a=0;3>a;a++)n=d3.select("#selectionTable tbody").append("tr").attr("class","content"),n.append("td").style("color","white").text(" .")}function I(t,e){var n=e;d3.selectAll(".altIndicator").selectAll("path.line.altId"+n).remove(),d3.selectAll(".altIndicator").filter(function(t){return ne.has(t.item)}).append("path").attr("class",function(){return"line altId"+n}).attr("d",function(t){return me(ne.get(t.item))}).style("opacity",.5).style("stroke-width",function(){return t?3:2}).style("stroke-dasharray",function(){return t?"":"2,2"})}function A(t,e,n){var r,a=function(t){return 50*H.indexOf(t)},i=[{x:0,y:25},{x:0,y:0}];ne=S(n.keys(),U.get(n.group).xScale),r=d3.selectAll(".altIndicator").filter(function(t){return ne.has(t.item)}),r.selectAll("path.line.altId"+e).transition().delay(a).duration(800).attr("d",function(){return me(i)}).transition().attr("d",function(t){return me(ne.get(t.item))}),r.filter(function(){return d3.select(this).select("path.line.altId"+e).empty()}).append("path").attr("class",function(){return"line altId"+e}).style("opacity",0).transition().delay(a).duration(800).attr("d",function(){return me(i)}).style("stroke-width",function(){return t?3:2}).style("stroke-dasharray",function(){return t?"":"2,2"}).style("opacity",.5).transition().attr("d",function(t){return me(ne.get(t.item))}),r=d3.selectAll(".altIndicator").filter(function(t){return!ne.has(t.item)}),r.selectAll("path.line.altId"+e).style("opacity",.5).transition().delay(a).duration(750).style("opacity",0).remove()}function E(t,e,n){return[{x:0,y:25},{x:n(c(e))-n(c(t)),y:0}]}function S(t,e){var n=d3.map();return 1===t.length?(n.set(t[0],[{x:0,y:25},{x:0,y:0}]),n):(t.sort(function(t,n){return d3.ascending(e(c(t)),e(c(n)))}),t.forEach(function(t,r,a){r<a.length-1&&n.set(t,E(a[r],a[r+1],e))}),n)}function B(){for(var t=0;t<H.length;t++){for(var e=[],n=0;n<H.length;n++)e[n]=0;re[t]=e}}function T(t){for(var e=Object.keys(t),n=e.length,r=1;n>r;r++)if(1===t[e[r]])for(var a=r+1;n>a;a++)1===t[e[a]]&&(re[r-1][a-1]+=t[e[0]])}function q(){for(var t=[],e=0;3>e;e++)t[e]={frequency:0,itemOne:"None",itemTwo:"None",fullItemOne:"None",fullItemTwo:"None"};for(var n=0;n<re.length;n++)if(!Z.has(H[n].item))for(var r=n+1;r<re.length;r++)if(!Z.has(H[r].item))for(var a=0;a<t.length;a++)if(re[n][r]>t[a].frequency){t.splice(a,0,{frequency:re[n][r],itemOne:H[n].itemShort,itemTwo:H[r].itemShort,fullItemOne:H[n].item,fullItemTwo:H[r].item}),t.pop();break}d3.selectAll("#patternTable tr.content").remove();for(var i=0;i<t.length;i++){var o=d3.select("#patternTable tbody").append("tr").datum([t[i].fullItemOne,t[i].fullItemTwo]).attr("class","content").on("click",function(t){"None"!==t[0]&&(v(t[0],!1),v(t[1],!0))});o.append("td").text(t[i].itemOne),o.append("td").text(t[i].itemTwo),o.append("td").text(L(t[i].frequency)),o.append("td").text(L(Number(100*t[i].frequency/V).toFixed(1)+"%"))}}function O(){var t=document.getElementById("sort").checked;U.forEach(function(e,n){var r=n.data.slice();n.xScale=n.xScale.domain(r.sort(t?function(t,e){return e.frequency-t.frequency}:function(t,e){return d3.ascending(t.index,e.index)}).map(function(t){return t.itemShort}));var a=d3.select(n.selector).transition().duration(750),i=function(t,e){return 50*e};a.selectAll(".x>.tick").delay(i).attr("transform",function(t){return"translate("+(n.xScale(t.itemShort)+n.xScale.rangeBand()/2)+",0)"}),d3.selectAll("g.toolTipTrans").filter(function(t){return t===n}).selectAll(".gtooltip").attr("transform",function(t){return"translate("+(n.xScale(t.itemShort)+n.xScale.rangeBand()/2)+", "+he+")"})}),$.forEach(function(t,e){A(!0,t,e)}),null!==te&&A(!1,ee+1,te)}function M(){console.log("show help");var t=5-se.top-ue.top,e=0;d3.select("div.interaction.help").style("background","white").style("border","0px solid darkgrey");var n=d3.select("svg.IEChart"),r=n.node().getBoundingClientRect(),a=(r.right-r.left)/2-200,i=(r.bottom-r.top)/2-100;n.append("rect").attr("class","helpBox").attr("x",r.right).attr("y",t).attr("width",1).attr("height",1).style("stroke","black").style("stroke-width",2).style("fill","white").style("opacity",0).transition().delay(e).duration(400).attr("x",a).attr("y",i).attr("width",400).attr("height",200).style("opacity",.9);var o=[];o[0]="- to include item: click on item",o[1]="- to exclude item: 'shift' + click on item",o[2]="- to include item OR: 'alt' + click on item",o[3]="- exclude item OR: 'alt' + 'shift' + click on item",o[4]="To finish OR selections, select the last item without 'alt' ",o[6]="Exploration table shows for the current selection",o[7]="the TOP 3 most frequent 2-item sets",o[8]="which don't contain the already selected items.",o.forEach(function(t,r){n.append("text").attr("class","helpBox").attr("x",a+25).attr("y",i+20+18*r).attr("dy",".71em").attr("fill","black").text(t).style("opacity",0).transition().delay(300).duration(e).style("opacity",1)})}function C(){console.log("remove help"),d3.select("svg.IEChart").selectAll(".helpBox").remove(),d3.select("div.interaction.help").style("background","lightgrey").style("border","1px solid darkgrey")}function L(t){var e=d3.format(",.0f");if("."===ie){if(+t%1!==0)return t.split(".").join(",");var n=e(t).split(",").join(".");return n}return+t%1!==0?t:e(t)}function D(t){t=t.substring(4,t.length-1);var e=t.split(",");return e[0]=+e[0],e[1]=+e[1],e[2]=+e[2],e[0]=Math.round(e[0]+.9*(255-e[0])),e[1]=Math.round(e[1]+.9*(255-e[1])),e[2]=Math.round(e[2]+.9*(255-e[2])),"rgb("+e[0]+", "+e[1]+", "+e[2]+")"}function F(){d3.selectAll(".x.axis g.tick>text").attr("unselectable","on"),d3.selectAll(".y.axis g.tick>text").attr("unselectable","on"),window.onload=function(){document.onselectstart=function(){return!1}}}function N(){var t=[];t.push('<div class="options container">'),t.push("<h3>Info</h3>"),t.push('<div class="header">current filter:</div>'),t.push('<div id="selectionDiv">'),t.push('<table id="selectionTable">'),t.push("<tbody>"),t.push('<tr class="content"><td><font color="white"> .</font></td></tr>'),t.push('<tr class="content"><td><font color="white"> .</font></td></tr>'),t.push('<tr class="content"><td><font color="white"> .</font></td></tr>'),t.push("</tbody>"),t.push("</table>"),t.push("</div>"),t.push('<div class="break"></div>'),t.push('<div class="colLeft" id ="itemFrequency">frequency:</div><div class="info left"></div>'),t.push('<div class="colRight" id ="itemPercent">percent:</div><div class="info right"></div>'),t.push("</div>"),t.push('<div id="empty" class="container"></div>'),t.push('<div id="mining" class="container">'),t.push("<h3>Exploration</h3>"),t.push('<div id="patternDiv">'),t.push('<table id="patternTable">'),t.push("<thead>"),t.push("<tr>"),t.push("<th>item 1</th>"),t.push("<th>item 2</th>"),t.push("<th>frequency</th>"),t.push("<th>percent</th>"),t.push("</tr>"),t.push("</thead>"),t.push("<tbody>"),t.push("</tbody>"),t.push("</table>"),t.push("</div>"),t.push('<div class="interaction sort">'),t.push('<input id="sort" type="checkbox">sort by frequency'),t.push("</div>"),t.push('<div class="interaction update">'),t.push('<input id="update_axis" type="checkbox" name="update">update axis'),t.push("</div>"),t.push('<div class="interaction help">help</div>'),t=t.join(""),d3.select("body").insert("div",":first-child").attr("class","center").html(t),d3.select("input#sort").on("click",e.resort),d3.select("input#update_axis").on("click",e.update),d3.select(".interaction.help").on("mouseover",e.showHelp).on("mouseout",e.removeHelp)}var R,H,_,j,J,z,G,K,P,Y,W,X,Q=!0,U=d3.map(),V=0,Z=d3.map(),$=d3.map(),te=null,ee=0,ne=d3.map(),re=[],ae=38,ie=",",oe=!0,le=!0,ce=d3.locale({decimal:",",thousands:".",grouping:[3],currency:["","€"],dateTime:"%a, %e %b %Y, %X",date:"%d.%m.%Y",time:"%H:%M:%S",periods:["",""],days:["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"],shortDays:["So","Mo","Di","Mi","Do","Fr","Sa"],months:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],shortMonths:["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dec"]}),se={top:20,right:20,bottom:20,left:20},ue={top:60,right:60,bottom:60,left:70},de=960,fe=500,pe=fe-se.top-se.bottom,he=pe-ue.top-ue.bottom,ge=2*(ue.bottom-25)-1,me=d3.svg.line().interpolate(function(t){var e=(t[0][0]+t[1][0])/2;return t.join("q "+e+","+ge+" ")}).x(function(t){return t.x}).y(function(t){return t.y});return e.barWidth=function(t){return arguments.length?(ae=t,e):ae},e.barHeight=function(t){return arguments.length?(he=t,e):he},e.decimalSeparator=function(t){return ie=t,e},e.drawGridLines=function(t){return oe=t,e},e.createHTMLFrame=function(t){return le=t,e},e.tickFormat=function(t){return X=t,e},e.update=function(){return p(!1),e},e.resort=function(){return O(),e},e.showHelp=function(){return M(),e},e.removeHelp=function(){return C(),e},e};