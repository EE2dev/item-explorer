var itemExplorerChart=function(t){"use strict";function e(e){e.each(function(r){se&&R(),console.log(r),console.log("_myData "+t),"undefined"!=typeof r?a(e,r):"undefined"!=typeof t?n(t,e):n("<pre>",e)})}function n(t,e){"<pre>"!==t?d3.csv(t,r,function(t,n){a(e,n)}):(H=d3.csv.parse(d3.select("pre#data").text()),H.forEach(function(t){r(t)}),console.log("hier"),console.log(H),a(e,H))}function r(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(t[e]=+t[e]);return t}function a(t,e){t.each(function(){H=e,o(H),$=d3.scale.linear().range([ge,0]),","===oe?W=d3.svg.axis().scale($).orient("left").ticks(10,X):(X=X?X:",.0f",W=d3.svg.axis().scale($).orient("left").tickFormat(ce.numberFormat(X)));var t=d3.select(this);K=t.append("svg").call(i);var n,r=0;d3.select("g.padding").append("g").attr("class","allTooltips"),U.forEach(function(t,e){n=d3.select("g.padding").datum(e).insert("g","g.allTooltips").attr("class","groupBlock group"+t),n.append("g").attr("class","x axis").attr("transform","translate(0,"+ge+")"),d3.select(e.selector+">.x.axis").call(e.axis),0===r?p(!0,t):p(!1,t),r++})})}function i(t){t.attr("width",fe).attr("height",pe).attr("class","IEChart").append("g").attr("class","margin").attr("transform","translate("+ue.left+","+ue.top+")").append("g").attr("class","padding").attr("transform","translate("+de.left+","+de.top+")")}function o(t){var e,n,r=d3.keys(t[0]).filter(function(t){return"_"===t.substring(0,1)?(G=t,!1):!0});return _=r.map(function(t,r){return n={item:t,itemShort:t,itemLong:t,color:"rgb(70, 130, 180)",frequency:0,index:r,group:""},e=t.split(":"),l(n,e),n}),d(),r=r.map(function(t){var e=t.split(":");return e[0]})}function l(t,e){t.itemLong=e[0],t.itemShort=e[0],e.forEach(function(e){switch(e.substring(0,3)){case"CO=":t.color=e.slice(3),"rgb"===t.color.substr(0,3)&&(t.color=t.color.replace(/ /g,","));break;case"LN=":t.itemLong=e.slice(3);break;case"DI=":t.group=e.slice(3).replace(/\s+/g,"_")}}),u(t.itemShort,t.group)}function s(t){return t.split(":")[0]}function c(t){var e=t.split(":"),n=e[0];return e.forEach(function(t){"LN="===t.substring(0,3)&&(n=t.slice(3))}),n}function u(t,e){var n;U.has(e)?(n=U.get(e),n.items.push(t)):n={items:[t],data:[],selector:"g.group"+e,width:-1,xScale:null,axis:null,firstTime:!0},U.set(e,n)}function d(){U.forEach(function(t,e){var n=e;n.width=e.items.length*ie,n.xScale=d3.scale.ordinal().domain(n.items).rangeRoundBands([0,n.width],.1),n.axis=d3.svg.axis().scale(n.xScale).orient("bottom"),U.set(t,n)})}function f(t){$.domain([0,j]);var e=d3.select(t.selector);e.insert("g","g.x.axis").attr("class","y axis").append("text").attr("x",-5).attr("y",-14).attr("dy",".71em").style("text-anchor","end").text(G.slice(1,G.length));var n=e.selectAll(".x>.tick").data(t.data),r=e.select(".x.axis").selectAll("g.tick").append("g").attr("class","indicator");e.selectAll(".x.axis g.tick>text").attr("class","unselect"),r.append("rect").attr("class","colorIndicator").attr("x",t.xScale.rangeBand()/2*-1).attr("y",0).attr("width",t.xScale.rangeBand()).attr("height",25).style("stroke","black").style("stroke-width",2).style("opacity",0),r.append("g").attr("class","altIndicator").style("stroke","black").style("stroke-width",2).style("opacity",.5),e.select("g.x.axis").append("text").attr("x",function(t){return t.width}).attr("y",28).attr("dy",".71em").style("text-anchor","end").text(t.selector.split("g.group")[1].replace("_"," ")),n.append("rect").attr("class","bar drawn").attr("x",-t.xScale.rangeBand()/2).attr("width",t.xScale.rangeBand()).attr("y",0).attr("height",0).style("fill",function(t){return t.color});var a=t.selector.split("g.")[1],i=d3.select("g.allTooltips").append("g").attr("class","toolTipTrans "+a).datum(t).selectAll("g.gtooltip").data(t.data,function(t){return t.itemShort}).enter().append("g").attr("class","gtooltip");i.attr("transform",function(t){var e=d3.selectAll(".x>.tick").filter(function(e){return e===t}).attr("transform");return e=e===e.split(",")[0]?e.substr(0,e.length-1)+", "+ge+")":e.split(",")[0]+", "+ge+")"}),i.append("rect").attr("class","selection bar unselect").attr("x",-t.xScale.rangeBand()/2).attr("width",t.xScale.rangeBand()).attr("y",function(){return-(ge-$(j))}).attr("height",ge+20-$(j)).on("mouseover",function(t){h(t)}).on("mouseout",function(){d3.selectAll(".tooltip").remove()}).on("click",function(t){d3.selectAll(".tooltip").remove(),d3.event.altKey?x(t.item):v(t.item,!0)}),e.select(".y.axis").call(W),F()}function p(t,e){var n;n="undefined"==typeof e?{items:[],data:_,selector:"g.group"}:U.get(e),t&&(z=0,B(),H.forEach(function(t){Q&&(V+=t[G]),y(t)&&(z+=t[G],T(t),_.forEach(function(e){1===t[e.item]&&(e.frequency+=t[G])}))})),n.data=_.filter(function(t){return-1!==n.items.indexOf(t.itemShort)});var r=d3.select("svg").transition().duration(750);if(Q){j=d3.max(_,function(t){return t.frequency}),f(n),n.firstTime=!1,U.set(e,n);var a=!1;if(U.forEach(function(t,e){a=a||e.firstTime}),Q=a,Q===!1){var i=0,o=0,l=15;r.selectAll(".groupBlock").attr("transform",function(t,e){var n=i;o=d3.select(this).select("g.x.axis").node().getBBox().width+d3.select(this).select("g.y.axis").node().getBBox().width,i+=o+l,0===e&&d3.select(this).select("g.y.axis").node().getBBox().width>de.left&&(de.left=d3.select(this).select("g.y.axis").node().getBBox().width,d3.select("svg.IEChart g.padding").attr("transform","translate("+de.left+", "+de.top+")"));var r="translate("+n+", 0)";return d3.selectAll("g.toolTipTrans").filter(function(e){return e===t}).attr("transform",r),r});var s=d3.select("svg.IEChart"),c=i+de.left;if(500>c){c=500;var u=ue.left+c/2-(i+de.left)/2;d3.select("svg.IEChart>g").attr("transform","translate("+u+", 0)")}s.attr("width",c),P=s.node().getBoundingClientRect().left,Y=s.node().getBoundingClientRect().right,s.attr("height",ge+ue.top+de.top+de.bottom+ue.bottom)}}if(!Q){J=document.getElementById("update_axis").checked?d3.max(_,function(t){return t.frequency}):j,$.domain([0,J]),k(),q(),r.selectAll(".y.axis").call(W);var d=r.selectAll(".bar.drawn").attr("y",function(t){return-(ge-$(t.frequency))}).attr("height",function(t){return ge-$(t.frequency)});t&&document.getElementById("sort").checked&&d.call(m,function(){O()}),le&&d3.selectAll(".y.axis").each(function(t){var e=t.width;d3.select(this).selectAll("g.tick").filter(function(t){return 0!==t}).append("path").attr("class","horizontalGrid").attr("d","M 0 0 L "+e+" 0")})}}function h(t){var e,n=41,r=-(ge-$(t.frequency))-n-10,a=r+n+10,i=d3.selectAll("g.gtooltip").filter(function(e){return e===t}),o=i.insert("g",".selection.bar").attr("class","tooltip textBoxGroup"),l=o.append("g").attr("class","tooltip textgroup");l.append("text").attr("class","tooltip firstLine").attr("x",0).attr("y",r+5).attr("dy",".71em").attr("fill","black").attr("text-anchor","middle").text(t.itemLong),l.append("text").attr("class","tooltip secondLine").attr("x",0).attr("y",r+4+18).attr("dy",".71em").attr("fill","black").attr("text-anchor","middle").text(G.slice(1,G.length)+": "+L(t.frequency)),e=d3.select(".tooltip.textgroup")[0][0].getBBox().width+6;var s=d3.selectAll(".bar.drawn").filter(function(e){return e===t}).style("fill");if("#"===s.charAt(0)){var c=s;s="rgb("+N(c).r+", "+N(c).g+", "+N(c).b+")"}o.insert("rect",".tooltip.textgroup").attr("class","tooltip box").attr("x",-e/2).attr("y",r).attr("width",e).attr("height",n).style("fill",D(s)).style("stroke",s),g(o),i.insert("path",".selection.bar").attr("class","tooltip triangle").attr("d"," M 0 "+a+"l -10 -10 l 20 0 l -10 10").style("fill",s).style("stroke",s)}function g(t){var e=t.node().getBoundingClientRect().left,n=t.node().getBoundingClientRect().right;P+2>e?(e=P+2-e,t.attr("transform","translate ("+e+" ,0)")):n+2>Y&&(n=Y-(n+2),t.attr("transform","translate ("+n+" ,0)"))}function m(t,e){var n;t.empty()?e():(n=t.size(),t.each("end",function(){n--,0===n&&e()}))}function y(t){if(Z.empty())return!0;var e=!0;if(Z.forEach(function(n,r){0===r.alternativeId&&(e=t[n]===r.condition?!0&&e:!1)}),!te.empty()){var n;te.forEach(function(r,a){n=!1,a.forEach(function(e,r){n=t[e]===r?!0:!1||n}),e=e&&n})}return e}function v(t,e){if(console.log("update : "+t),null===ee||!ee.has(t)&&!Z.has(t)){if(Z.has(t)){var n=Z.get(t).alternativeId;if(0!==n){var r=te.get(n);r.size()<=2?(te.remove(n),d3.selectAll(".altIndicator").selectAll("path.line.altId"+n).remove()):r.remove(t)}Z.remove(t);var a=Z.entries().filter(function(t){return t.value.alternativeId===n});1===a.length&&Z.set(a[0].key,{condition:Z.get(a[0].key).condition,alternativeId:0})}else if(d3.event.shiftKey)if(null!==ee){if(!b(t))return;ne++,ee.set(t,0),ee.forEach(function(t,e){Z.set(t,{condition:e,alternativeId:ne})}),te.set(ne,ee)}else Z.set(t,{condition:0,alternativeId:0});else if(null!==ee){if(!b(t))return;ne++,ee.set(t,1),ee.forEach(function(t,e){Z.set(t,{condition:e,alternativeId:ne})}),te.set(ne,ee)}else Z.set(t,{condition:1,alternativeId:0});ee=null,e&&(_.forEach(function(t){t.frequency=0}),p(!0))}}function x(t){Z.has(t)||(null===ee&&(ee=d3.map()),b(t)&&(d3.event.shiftKey?ee.has(t)?(ee.remove(t),d3.selectAll(".indicator").filter(function(e){return e.item===t}).style("fill","none").style("opacity",0)):ee.set(t,0):ee.has(t)?(ee.remove(t),d3.selectAll(".indicator").filter(function(e){return e.item===t}).style("fill","none").style("opacity",0)):ee.set(t,1),re=S(ee.keys(),U.get(ee.group).xScale),I(!1,ne+1),d3.selectAll(".indicator").each(function(t){ee.has(t.item)&&d3.select(this).select(".colorIndicator").style("fill",function(t){return 1===ee.get(t.item)?"green":"red"}).style("opacity",.5)}),ee.empty()&&(ee=null)))}function b(t){if(ee.empty())return _.forEach(function(e){e.item===t&&(ee.group=e.group)}),!0;var e,n=ee.keys()[0];return _.forEach("undefined"==typeof ee.group?function(r){r.item===n&&(ee.group=r.group),r.item===t&&(e=r.group)}:function(n){n.item===t&&(e=n.group)}),e===ee.group}function k(){var t=d3.round(z/V*100,1)+"%",e=[z,t];d3.selectAll("div.info").data(e).text(function(t){return L(t)}),d3.selectAll(".colorIndicator").each(function(t){Z.has(t.item)?d3.select(this).style("fill",function(t){return 1===Z.get(t.item).condition?"green":"red"}).style("opacity",.5):d3.select(this).style("fill","none").style("opacity",0)}),te.forEach(function(t,e){re=S(e.keys(),U.get(e.group).xScale),I(!0,t)}),w()}function w(){var t="";Z.forEach(function(e,n){0===n.alternativeId&&(t+=1===n.condition?"+"+c(e)+"\n":"-"+c(e)+"\n")}),te.forEach(function(e,n){t+="(",n.forEach(function(e,n){t+=1===n?"+"+c(e)+" || ":"-"+c(e)+" || "}),t=t.substring(0,t.length-4),t+=")\n"});var e=t.split("\n");d3.selectAll("#selectionTable tr.content").remove();var n;if(e.length>1)for(var r=0;r<e.length-1;r++)n=d3.select("#selectionTable tbody").append("tr").attr("class","content"),n.append("td").text(e[r]);else if(1===e.length)for(var a=0;3>a;a++)n=d3.select("#selectionTable tbody").append("tr").attr("class","content"),n.append("td").style("color","white").text(" .")}function I(t,e){var n=e;d3.selectAll(".altIndicator").selectAll("path.line.altId"+n).remove(),d3.selectAll(".altIndicator").filter(function(t){return re.has(t.item)}).append("path").attr("class",function(){return"line altId"+n}).attr("d",function(t){return ye(re.get(t.item))}).style("opacity",.5).style("stroke-width",function(){return t?3:2}).style("stroke-dasharray",function(){return t?"":"2,2"})}function A(t,e,n){var r,a=function(t){return 50*_.indexOf(t)},i=[{x:0,y:25},{x:0,y:0}];re=S(n.keys(),U.get(n.group).xScale),r=d3.selectAll(".altIndicator").filter(function(t){return re.has(t.item)}),r.selectAll("path.line.altId"+e).transition().delay(a).duration(800).attr("d",function(){return ye(i)}).transition().attr("d",function(t){return ye(re.get(t.item))}),r.filter(function(){return d3.select(this).select("path.line.altId"+e).empty()}).append("path").attr("class",function(){return"line altId"+e}).style("opacity",0).transition().delay(a).duration(800).attr("d",function(){return ye(i)}).style("stroke-width",function(){return t?3:2}).style("stroke-dasharray",function(){return t?"":"2,2"}).style("opacity",.5).transition().attr("d",function(t){return ye(re.get(t.item))}),r=d3.selectAll(".altIndicator").filter(function(t){return!re.has(t.item)}),r.selectAll("path.line.altId"+e).style("opacity",.5).transition().delay(a).duration(750).style("opacity",0).remove()}function E(t,e,n){return[{x:0,y:25},{x:n(s(e))-n(s(t)),y:0}]}function S(t,e){var n=d3.map();return 1===t.length?(n.set(t[0],[{x:0,y:25},{x:0,y:0}]),n):(t.sort(function(t,n){return d3.ascending(e(s(t)),e(s(n)))}),t.forEach(function(t,r,a){r<a.length-1&&n.set(t,E(a[r],a[r+1],e))}),n)}function B(){for(var t=0;t<_.length;t++){for(var e=[],n=0;n<_.length;n++)e[n]=0;ae[t]=e}}function T(t){for(var e=Object.keys(t),n=e.length,r=1;n>r;r++)if(1===t[e[r]])for(var a=r+1;n>a;a++)1===t[e[a]]&&(ae[r-1][a-1]+=t[e[0]])}function q(){for(var t=[],e=0;3>e;e++)t[e]={frequency:0,itemOne:"None",itemTwo:"None",fullItemOne:"None",fullItemTwo:"None"};for(var n=0;n<ae.length;n++)if(!Z.has(_[n].item))for(var r=n+1;r<ae.length;r++)if(!Z.has(_[r].item))for(var a=0;a<t.length;a++)if(ae[n][r]>t[a].frequency){t.splice(a,0,{frequency:ae[n][r],itemOne:_[n].itemShort,itemTwo:_[r].itemShort,fullItemOne:_[n].item,fullItemTwo:_[r].item}),t.pop();break}d3.selectAll("#patternTable tr.content").remove();for(var i=0;i<t.length;i++){var o=d3.select("#patternTable tbody").append("tr").datum([t[i].fullItemOne,t[i].fullItemTwo]).attr("class","content").on("click",function(t){"None"!==t[0]&&(v(t[0],!1),v(t[1],!0))});o.append("td").text(t[i].itemOne),o.append("td").text(t[i].itemTwo),o.append("td").text(L(t[i].frequency)),o.append("td").text(L(Number(100*t[i].frequency/V).toFixed(1)+"%"))}}function O(){var t=document.getElementById("sort").checked;U.forEach(function(e,n){var r=n.data.slice();n.xScale=n.xScale.domain(r.sort(t?function(t,e){return e.frequency-t.frequency}:function(t,e){return d3.ascending(t.index,e.index)}).map(function(t){return t.itemShort}));var a=d3.select(n.selector).transition().duration(750),i=function(t,e){return 50*e};a.selectAll(".x>.tick").delay(i).attr("transform",function(t){return"translate("+(n.xScale(t.itemShort)+n.xScale.rangeBand()/2)+",0)"}),d3.selectAll("g.toolTipTrans").filter(function(t){return t===n}).selectAll(".gtooltip").attr("transform",function(t){return"translate("+(n.xScale(t.itemShort)+n.xScale.rangeBand()/2)+", "+ge+")"})}),te.forEach(function(t,e){A(!0,t,e)}),null!==ee&&A(!1,ne+1,ee)}function M(){console.log("show help");var t=5-ue.top-de.top,e=0;d3.select("div.interaction.help").style("background","white").style("border","0px solid darkgrey");var n=d3.select("svg.IEChart"),r=n.node().getBoundingClientRect(),a=(r.right-r.left)/2-200,i=(r.bottom-r.top)/2-100;n.append("rect").attr("class","helpBox").attr("x",r.right).attr("y",t).attr("width",1).attr("height",1).style("stroke","black").style("stroke-width",2).style("fill","white").style("opacity",0).transition().delay(e).duration(400).attr("x",a).attr("y",i).attr("width",400).attr("height",200).style("opacity",.9);var o=[];o[0]="- to include item: click on item",o[1]="- to exclude item: 'shift' + click on item",o[2]="- to include item OR: 'alt' + click on item",o[3]="- exclude item OR: 'alt' + 'shift' + click on item",o[4]="To finish OR selections, select the last item without 'alt' ",o[6]="Exploration table shows for the current selection",o[7]="the TOP 3 most frequent 2-item sets",o[8]="which don't contain the already selected items.",o.forEach(function(t,r){n.append("text").attr("class","helpBox").attr("x",a+25).attr("y",i+20+18*r).attr("dy",".71em").attr("fill","black").text(t).style("opacity",0).transition().delay(300).duration(e).style("opacity",1)})}function C(){console.log("remove help"),d3.select("svg.IEChart").selectAll(".helpBox").remove(),d3.select("div.interaction.help").style("background","lightgrey").style("border","1px solid darkgrey")}function L(t){var e=d3.format(",.0f");if("."===oe){if(+t%1!==0)return t.split(".").join(",");var n=e(t).split(",").join(".");return n}return+t%1!==0?t:e(t)}function D(t){t=t.substring(4,t.length-1);var e=t.split(",");return e[0]=+e[0],e[1]=+e[1],e[2]=+e[2],e[0]=Math.round(e[0]+.9*(255-e[0])),e[1]=Math.round(e[1]+.9*(255-e[1])),e[2]=Math.round(e[2]+.9*(255-e[2])),"rgb("+e[0]+", "+e[1]+", "+e[2]+")"}function F(){d3.selectAll(".x.axis g.tick>text").attr("unselectable","on"),d3.selectAll(".y.axis g.tick>text").attr("unselectable","on"),window.onload=function(){document.onselectstart=function(){return!1}}}function N(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,function(t,e,n,r){return e+e+n+n+r+r});var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:null}function R(){var t=[];t.push('<div class="options container">'),t.push("<h3>Info</h3>"),t.push('<div class="header">current filter:</div>'),t.push('<div id="selectionDiv">'),t.push('<table id="selectionTable">'),t.push("<tbody>"),t.push('<tr class="content"><td><font color="white"> .</font></td></tr>'),t.push('<tr class="content"><td><font color="white"> .</font></td></tr>'),t.push('<tr class="content"><td><font color="white"> .</font></td></tr>'),t.push("</tbody>"),t.push("</table>"),t.push("</div>"),t.push('<div class="break"></div>'),t.push('<div class="colLeft" id ="itemFrequency">frequency:</div><div class="info left"></div>'),t.push('<div class="colRight" id ="itemPercent">percent:</div><div class="info right"></div>'),t.push("</div>"),t.push('<div id="empty" class="container"></div>'),t.push('<div id="mining" class="container">'),t.push("<h3>Exploration</h3>"),t.push('<div id="patternDiv">'),t.push('<table id="patternTable">'),t.push("<thead>"),t.push("<tr>"),t.push("<th>item 1</th>"),t.push("<th>item 2</th>"),t.push("<th>frequency</th>"),t.push("<th>percent</th>"),t.push("</tr>"),t.push("</thead>"),t.push("<tbody>"),t.push("</tbody>"),t.push("</table>"),t.push("</div>"),t.push('<div class="interaction sort">'),t.push('<input id="sort" type="checkbox">sort by frequency'),t.push("</div>"),t.push('<div class="interaction update">'),t.push('<input id="update_axis" type="checkbox" name="update">update axis'),t.push("</div>"),t.push('<div class="interaction help">help</div>'),t=t.join(""),d3.select("body").insert("div",":first-child").attr("class","center").html(t),d3.select("input#sort").on("click",e.resort),d3.select("input#update_axis").on("click",e.update),d3.select(".interaction.help").on("mouseover",e.showHelp).on("mouseout",e.removeHelp)}var H,_,j,J,z,G,K,P,Y,$,W,X,Q=!0,U=d3.map(),V=0,Z=d3.map(),te=d3.map(),ee=null,ne=0,re=d3.map(),ae=[],ie=38,oe=",",le=!0,se=!0,ce=d3.locale({decimal:",",thousands:".",grouping:[3],currency:["","€"],dateTime:"%a, %e %b %Y, %X",date:"%d.%m.%Y",time:"%H:%M:%S",periods:["",""],days:["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"],shortDays:["So","Mo","Di","Mi","Do","Fr","Sa"],months:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],shortMonths:["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dec"]}),ue={top:20,right:20,bottom:20,left:20},de={top:60,right:60,bottom:60,left:70},fe=960,pe=500,he=pe-ue.top-ue.bottom,ge=he-de.top-de.bottom,me=2*(de.bottom-25)-1,ye=d3.svg.line().interpolate(function(t){var e=(t[0][0]+t[1][0])/2;return t.join("q "+e+","+me+" ")}).x(function(t){return t.x}).y(function(t){return t.y});return e.barWidth=function(t){return arguments.length?(ie=t,e):ie},e.barHeight=function(t){return arguments.length?(ge=t,e):ge},e.thousandsSeparator=function(t){return oe=t,e},e.drawGridLines=function(t){return le=t,e},e.createHTMLFrame=function(t){return se=t,e},e.tickFormat=function(t){return X=t,e},e.update=function(){return p(!1),e},e.resort=function(){return O(),e},e.showHelp=function(){return M(),e},e.removeHelp=function(){return C(),e},e};